# 13. 교착 상태
- [13. 교착 상태](#13-교착-상태)
  - [13-1. 교착 상태](#13-1-교착-상태)
    - [(1) 식사하는 철학자 문제](#1-식사하는-철학자-문제)
    - [(2) 자원 할당 그래프](#2-자원-할당-그래프)
      - [자원 할당 그래프 규칙](#자원-할당-그래프-규칙)
      - [교착 상태 그래프의 특징](#교착-상태-그래프의-특징)
    - [(3) 교착 상태 발생 조건](#3-교착-상태-발생-조건)
      - [1. 상호 배제](#1-상호-배제)
      - [2. 점유와 대기](#2-점유와-대기)
      - [3. 비선점](#3-비선점)
      - [4. 원형 대기](#4-원형-대기)
  - [13-2. 교착 상태 해결 방법](#13-2-교착-상태-해결-방법)
    - [(1) 교착 상태 예방](#1-교착-상태-예방)
      - [1. 상호 배제 없애기](#1-상호-배제-없애기)
      - [2. 점유와 대기 없애기](#2-점유와-대기-없애기)
      - [3. 비선점 조건 없애기](#3-비선점-조건-없애기)
      - [4. 원형 대기 조건을 없애기](#4-원형-대기-조건을-없애기)
    - [(2) 교착 상태 회피](#2-교착-상태-회피)
    - [(3) 교착 상태 검출 후 회복](#3-교착-상태-검출-후-회복)
      - [1. 선점을 통한 회복](#1-선점을-통한-회복)
      - [2. 프로세스 강제 종료를 통한 회복](#2-프로세스-강제-종료를-통한-회복)
    - [(4) 교착 상태를 무시하기](#4-교착-상태를-무시하기)
      - [1. 타조 알고리즘](#1-타조-알고리즘)
  - [Q\&A](#qa)
    - [Q1. 자원 할당 그래프가 무엇이고 어떤 방식으로 표현하는가?](#q1-자원-할당-그래프가-무엇이고-어떤-방식으로-표현하는가)
    - [Q2. 교착 상태 발생 조건에 대해 설명하세요.](#q2-교착-상태-발생-조건에-대해-설명하세요)
    - [Q3. 교착 상태를 해결하는 방법에 대해 설명하세요.](#q3-교착-상태를-해결하는-방법에-대해-설명하세요)

## 13-1. 교착 상태
### (1) 식사하는 철학자 문제
- 원탁에 5명의 철학자가 앉아있고 앞에 맛있는 식사가 있음
- 식사에 필요한 포크 5개가 있지만 음식은 한번에 두개의 포크로 먹을 수 있는 음식임  
=> 모든 철학자가 동시에 포크를 집어 식사를 하면 어떤 철학자도 식사를 할 수 없고 영원히 생각만 하는 상황이 발생함  

- 모든 철학자가 왼쪽 포크를 집어들면 모두가 오른쪽 프코를 집어 들 수 없기 때문에 다른 철학자가 포크를 내려놓을 때까지 기다려야 함  
=> 이 상태를 **교착 상태**라고 함  

- 교착 상태 : 일어나지 않을 사건을 기다리며 진행이 멈춰버리는 현상
- 철학자 = 프로세스 또는 스레드
- 포크 = 자원
- 생각하는 행위 = 자원을 기다리는 것
- 포크는 한번에 하나의 프로세스 혹은 스레드만 접근할 수 있음 = 임계 구역
![alt text](<교착 상태.png>)

- 교착 상태는 다양한 상황에서 발생함
  - 예시 : 뮤텍스 락
    - 임계구역 진입 전 프로세스 A가 lock1을 잠그고, 프로세스 B가 lock2를 잠금
    - 각자 lock2, lock1이 사용 가능한 타이밍을 기다림

- 해결하기 위해 교착 상태의 상황과 교착 상태가 발생하는 근본적인 이유를 알아야 함

### (2) 자원 할당 그래프
- 교착 상태가 발생했을 때 상황을 한 눈에 보기 쉽게 표현한 그래프
- 어떤 프로세스가 어떤 자원을 사용하고 있고 어떤 자원을 기다리고 있는지를 표현한 간단한 그래프

#### 자원 할당 그래프 규칙
1. 프로세스는 원으로, 자원의 종류는 사각형으로 표현
    ![alt text](<프로세스, 자원.png>)
2. 사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현
    - 같은 자원일지라도 사용 가능한 자원의 개수가 다를 수 있음
    ![alt text](<자원의 개수.png>)
3. 프로세스가 어떤 자원을 할당받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시
    - 자원이 프로세스에 할당되면 화살표로 연결, 자원 이용을 끈태고 반납하면 화살표 삭제
    ![alt text](<자원 할당.png>)
4. 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시
    ![alt text](<프로세스 자원 대기.png>)

#### 교착 상태 그래프의 특징
- 교착 상태가 발생한 상황은 자원 할당 그래프가 원의 형태를 띄고 있음

### (3) 교착 상태 발생 조건
- 교착 상태는 상호 배제, 점유와 대기, 비선점, 원형 대기 일 때 발생할 가능성이 높음

#### 1. 상호 배제
- 교착 상태의 근본적인 원인은 자원을 한번에 하나의 프로세스만 이용 가능하기 때문
- 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 **상호 배제** 상황에서 교착 상태 발생

#### 2. 점유와 대기
- 자원을 보유한 채 다른 자원을 기다렸기 때문에 문제가 발생
- 자원을 할당받은 상태에서 다른 자원을 할당 받기를 기다리는 상태를 **점유와 대기**라고 함

#### 3. 비선점
- 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 이용할 수 있는 **비선점 자원**이기 때문에 다른 프로세스틔 자원을 강제로 빼앗지 못하여 교착 상태 발생

#### 4. 원형 대기
- 교착 상태가 발생한 이유는 프로세스들과 프로세스가 요청 및 할당 받은 자원이 원의 형태를 이루었기 때문
- 자원 할당 그래프가 원희 형태로 그려지면 교착 상태가 발생할 수 있음

## 13-2. 교착 상태 해결 방법
### (1) 교착 상태 예방
- 상호 배제, 점유와 대기, 비선점, 원형 대기 중 하나의 조건이라도 만족시키지 않게 할당하면 교착 상태는 발생하지 않음

#### 1. 상호 배제 없애기
- 모든 자원을 공유 가능하게 만드는 것 => 현실적으로 모든 자원의 상호 배제를 없애는 것은 무리가 있음

#### 2. 점유와 대기 없애기
- 자원을 모두 할당하거나 아예 할당하지 않는 방식으로 배분
- 이론적으로는 교착 상태를 해결할 수 있음
- 하지만 자원의 활용률이 낮아지는 단점이 있음
- 한 프로세스에 자원을 몰아주고 모두 사용하면 다음 프로세스에 몰아줄 수 있음
- 당장 자원이 필요해도 기다릴 수 밖에 없는 프로세스와 사용되지 않으면서 오랫동안 할당되는 자원을 다수 양산하기 때문에 자원의 활용률이 낮아짐
- 점유와 대기를 금지하면 자원을 많이 사용하는 프로세스는 자원을 사용할 타이밍을 확보하기가 어렵고 무한정 기다리게 되는 **기아 현상**을 야기할 우려가 있음

#### 3. 비선점 조건 없애기
- 선점하여 사용할 수 있는 일부 자원에 대해서는 자원을 빼앗아 사용할 수 있을 때 효과적
  - ex : CPU
- 모든 자원이 이렇게 선점 가능한 것이 아님
  - ex : 프린터
- 비선점 조건을 없애서 교착 상태를 예방하는 방법은 범용성이 떨어짐

#### 4. 원형 대기 조건을 없애기
- 모든 자원에 번호를 붙이고 오름차순으로 자원을 할당
- 철학자들이 원형이 아니라 일렬로 앉아서 식사하는 상황과 유사
- 비교적 현실적이고 실용적이나 모든 컴퓨터 시스템 내에 존재하는 수많은 자원에 번호를 붙이는 일은 간단하지 않음
- 어떤 번호를 붙이는지에 따라 특정 자원의 활용률이 떨어질 수 있음

- 교착 상태의 발생 조건을 원천적으로 제거하고 사전에 방지하는 예방 방식은 교착 상태가 발생하지 않지만 여러 부작용이 따름


### (2) 교착 상태 회피
- 교착 상태 회피 : 교착 상태가 발생하지 않을 정도로만 조심히 자원을 할당하는 방식
  - 교착 상태를 한정된 자원의 무분별한 할당으로 인해 발생하는 문제로 간주
  - 프로세스들에 할당할 수 있는 자원이 한정된 상황에서 모든 프로세스들이 한번에 많은 자원을 요구하면 교착 상태가 발생할 위험이 증가

- 안전 상태 : 교착 상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당받고 종료될 수 있는 상태
  - 안전 순서열대로 프로세스들에 자원을 배분하여 교착 상태가 발생하지 않는 상태
- 불안전 상태 : 교착 상태가 발생할 수도 있는 상황
  - 안전 순서열이 없는 상태
- 안전 순서열 : 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서를 의미

- 교착 상태 회피를 위해서는 시스템 상태가 안전 상태에서 안전 상태로 움직이는 경우에만 자원을 할당하면 됨

### (3) 교착 상태 검출 후 회복
- 교착 상태 검출 후 회복 : 교착 상태 발생을 인정하고 사후에 조치하는 방식
  - 운영 체제가 프로세스들이 자원을 요구할 때마다 모두 할당하며 교착 상태 발생 여부를 주기적으로 검사
  - 교착 상태가 검출되면 아래와 같은 방식으로 회복

#### 1. 선점을 통한 회복
- 교착 상태가 해결될 때까지 한 프로세스씩 자원을 모아줌

#### 2. 프로세스 강제 종료를 통한 회복
- 가장 단순하면서 확실함
- 교착 상태에 놓인 프로세스를 모두 강제 종료할 수도 있고 교착 상태가 없어질 때까지 하나씩 강제 종료할 수 있음
- 모두 강제 종료하면 가장 확실하지만 작업 내역을 잃게 될 가능성이 있음
- 하나씩 강제 종료하면 작업 내역을 잃는 프로세스는 최대한 줄일 수 있지만 교착 상태가 없어졌는지 여부를 확인하는 과정에서 오버헤드를 야기

### (4) 교착 상태를 무시하기
#### 1. 타조 알고리즘
- 타조가 문제에 처했을 때 땅에 묻고 모른 체 하는 모습에서 따옴
- 드물게 발생하는 잠재적 문제를 무시로 대처하기
- 문제 발생의 빈도나 심각성에 따라 최대 효율을 추구하는 엔지니어 입장에서 적합

## Q&A
### Q1. 자원 할당 그래프가 무엇이고 어떤 방식으로 표현하는가?
A1. 자원 할당 그래프란 일어나지 않을 사건을 기다리며 진행이 멈춰버리는 교착 상태를 보기 쉽게 표현한 그래프입니다. 어떤 프로세스가 어떤 자원을 사용하고 있는지를 확인할 수 있습니다. 프로세스는 원으로, 자원은 사각형으로 표현하며 사용할 수 있는 자원의 수는 점으로 표현하고 화살표를 통해 자원을 사용하거나 기다리고 있는 것을 표현할 수 있습니다.

### Q2. 교착 상태 발생 조건에 대해 설명하세요.
A2. 교착 상태 발생 조건은 상호배제, 점유와 대기, 비선점, 원형 대기가 있습니다. 모두 만족할 때 교착상태가 발생할 확률이 높습니다. 상호배제는 자원을 한번에 하나의 프로세스만 사용할 수 있는 것을 말합니다. 점유와 대기는 자원을 보유한 채 다른 자원을 할당받기를 대기 하는 상태를 말합니다. 비선점의 경우 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 이용할 수 있는 자원이라는 것을 의미하며, 원형 대기는 프로세스들과 요청 및 할당을 받은 자원이 원의 형태를 띄는 것을 의미합니다.

### Q3. 교착 상태를 해결하는 방법에 대해 설명하세요.
A3. 각 교착 상태 발생 조건인 점유와 대기, 비선점, 원형 대기, 상호 배제를 없애면 교착 상태를 해결할 수 있지만 각각 상황에 따라 단점들이 있습니다. 교착 상태 회피를 할 수도 있습니다. 교착 상태가 발생하지 않을 정도로만 조심히 자원을 할당하는 방식을 의미합니다. 안전 순서열에 따라 프로세스를 할당합니다. 교착 상태 검출 후 회복하는 경우는 선점을 하거나 프로세스 강제 종료를 통한 회복이 있습니다.
