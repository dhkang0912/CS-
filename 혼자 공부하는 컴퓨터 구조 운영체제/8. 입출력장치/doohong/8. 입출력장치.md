# 8. 입출력장치
- [8. 입출력장치](#8-입출력장치)
  - [8-1. 장치 컨트롤러와 장치 드라이버](#8-1-장치-컨트롤러와-장치-드라이버)
    - [1) 장치 컨트롤러](#1-장치-컨트롤러)
    - [2) 장치 드라이버](#2-장치-드라이버)
  - [8-2. 다양한 입출력 방법](#8-2-다양한-입출력-방법)
    - [1) 프로그램 입출력](#1-프로그램-입출력)
    - [1-2) 메모리 맵 입출력](#1-2-메모리-맵-입출력)
    - [1-3) 고립형 입출력](#1-3-고립형-입출력)
    - [1-3) 인터럽트 기반 입출력](#1-3-인터럽트-기반-입출력)
    - [1-4) DMA 입출력](#1-4-dma-입출력)
    - [2) 입출력 버스](#2-입출력-버스)
  - [Q\&A](#qa)
    - [Q1. 장치 컨트롤러와 장치 드라이버에 대해 설명하시오.](#q1-장치-컨트롤러와-장치-드라이버에-대해-설명하시오)
    - [Q2. 메모리 맵 입출력의 특징과 고립형 입출력 특징에 대해 설명하시오.](#q2-메모리-맵-입출력의-특징과-고립형-입출력-특징에-대해-설명하시오)
    - [Q3. 인터럽트 기반 입출력과 DMA 입출력의 특징에 대해 설명하시오.](#q3-인터럽트-기반-입출력과-dma-입출력의-특징에-대해-설명하시오)

## 8-1. 장치 컨트롤러와 장치 드라이버
### 1) 장치 컨트롤러
- 입출력 장치를 다루는 것이 CPU나 메모리보다 더 까다롭다
  - 입출력 장치가 너무 다양함
  - 입출력 장치의 데이터 전송률이 낮음
    - 전송률 : 데이터를 얼마나 빨리 교환할 수 있는지를 나타내는 지표  
  => 입출력장치는 컴퓨터에 직접 연결하지 않고 **장치 컨트롤러**를 통해 연결됨

- 장치 컨트롤러
  - 입출력 제어기, 입출력 모듈 등 다양하게 불림
  - 모든 입출력장치는 각자의 장치 컨트롤러를 통해 컴퓨터 내부와 정보를 주고 받음
  - 장치 컨트롤러는 하나 이상의 입출력장치와 연결됨

<br>

- 장치 컨트롤러의 역할
  - CPU와 입출력장치 간의 통신 중개
  - 오류 검출  
  => 장치 컨트롤러가 일종의 번역가 역할을 하고 그 과정에서 연결된 입출력장치에 문제가 없는지 확인함

  - 데이터 버퍼링
    - 버퍼링 : 전송률이 높은 장치와 낮은 장치 사이에 주고 받는 데이터를 **버퍼**라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법
    - '버퍼에 데이터를 조금씩 모았다가 한꺼번에 내보내거나 데이터를 한번에 많이 받아 조금씩 내보내는 방법'  
    => 전송률이 높은 CPU와 일반적으로 전송률이 낮은 입출력장치와의 전송률 차이를 데이터 버퍼링으로 완화함

<br>

- 장치 컨트롤러의 간략화된 내부 구조
  ![alt text](<장치 컨트롤러의 내부 구조.png>)
  - 데이터 레지스터
    - CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터
    - 데이터 레지스터가 버퍼 역할을 하여 데이터 버퍼링으로 전송률 차이를 완화함
    - 최근 주고 받는 데이터가 많은 입출력장치에서는 레지스터 대신 RAM을 사용하기도 함
  - 상태 레지스터
    - 입출력 장치가 입출력 작업을 할 준비가 되어있는지, 입출력 작업의 완료 여부, 오류 여부 등의 상태가 저장됨
  - 제어 레지스터
    - 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장함  
  => 레지스터들에 담긴 값들은 버스를 타고 CPU나 다른 입출력장치로 전달되거나, 장치 컨트롤러에 연결된 입출력장치로 전달됨

### 2) 장치 드라이버
- 장치 드라이버
  - 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고 받을 수 있게 하는 프로그램
  - 실행과정에서 메모리에 저장됨  
  => 장치 컨트롤러가 입출력장치를 연결하기 위한 하드웨어적 통로라면 장치 드라이버는 입출력 장치를 연결하기 위한 소프트웨어적 통로
  ![!\[alt text\](image.png)](<장치 드라이버와 컨트롤러.png>)

## 8-2. 다양한 입출력 방법
- 장치 컨트롤러와 CPU가 정보를 주고 받는 방법
  - 프로그램 입출력
  - 인터럽트 기반 입출력
  - DMA 입출력

### 1) 프로그램 입출력
- 기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법
- CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행함
  ![!\[alt text\](image.png)](<프로그램 입출력 과정.png>)
- 입출력 작업은 CPU가 장치 컨트롤러의 레지스터 값을 읽고 씀으로써 이루어짐

<br>

- CPU는 여러 장치 속 레지스터들을 모두 알고 있기 어려움  
  => 명령어 표현 및 메모리 저장 방식 : **메모리 맵 입출력, 고립형 입출력**

### 1-2) 메모리 맵 입출력
- 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법
- 주소 공간에서 일부를 아래와 같이 약속했다고 가정했을 때
  ![!\[alt text\](image.png)](<메모리 맵 입출력 주소 공간.png>)
  ![!\[alt text\](image.png)](<주소 공간 위치.png>) 
  - CPU는 '517번지를 읽어 들여라'라는 명령어로 키보드 상태를 읽을 수 있음
  - 그리고 '518번지에 를 써라라는 명령어로 하드 디스크 컨트롤러의 데이터 레지스터로 데이터를 보낼 수 있음'
  - 메모리 맵 입출력 방식에서 CPU는 메모리 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 대하듯 하면 됨
  - 메모리에 접근하는 방식이 다를 필요가 없음

### 1-3) 고립형 입출력
- 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법
  - CPU는 입출력장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용함
  ![!\[alt text\](image.png)](<고립형 입출력 방식.png>)
  ![!\[alt text\](image.png)](<메모리 맵 입출력 VS 고립형 입출력.png>)


### 1-3) 인터럽트 기반 입출력
- 인터럽트 
  - CPU가 입출력장치에 처리할 내용을 명령하면 입출력장치가 명령어를 수행하는 동안 CPU는 다른 일을 할 수 있음
  - 입출력 장치가 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 멈추고 해당 인터럽트를 처리하는 프로그램인 인터럽트 서비스 루틴을 실행한 뒤 다시 하던 일로 되돌아옴
- 입출력장치에 의한 하드웨어 인터럽트는 입출력장치가 아닌 장치 컨트롤러에 의해 발생
  - **CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력 장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 일을 할 수 있음**
  ![!\[alt text\](image.png)](<인터럽트 기반 요청 - 작업 끝.png>)
  - 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 백업하고 인터럽트 서비스 루틴을 실행
  ![!\[alt text\](image-1.png)](<인터럽트 기반 입출력-입력요청.png>)

<br>

- 여러 입출력장치에서 인터럽트가 동시에 발생한 경우는 어떻게 인터럽트를 처리해야할까?
  - 인터럽트가 발생한 순서대로 처리
    - CPU가 플래그 레지스터 속 인터럽트 비트를 비활성화한 채 인터럽트를 처리하는 경우 다른 입출력 장치에 의한 하드웨어 인터럽트를 받아들이지 않기 때문에 순차적으로 하드웨어 인터럽트를 처리하게 됨
    - **하지만 현실에서는 우선순위를 고려해야 함**
  - 인터럽트의 우선순위를 고려하여 처리
  ![!\[alt text\](image.png)](<인터럽트 입출력-우선순위 고려.png>)
    - **프로그래머블 인터럽트 컨트롤러 (PIC : Programmable Interupt Controller)**
      - 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트가 무엇인지 알려주는 장치
      - PIC에 연결된 장치 컨트롤러들이 동시에 하드웨어 인터럽트 요청을 보내면 PIC는 이들의 우선순위를 판단하여 CPU에 가장 먼저 처리할 인터럽트를 알려줌  
      ![!\[alt text\](image.png)](PIC.png)

    <br>
    - PIC의 다중 인터럽트 처리 과정  
      1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호들을 받아들임  
      2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보냄  
      3. CPU는 PIC에 인터럽트 확인 신호를 보냄  
      4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보냄  
      5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행함  
    
    ![!\[alt text\](image.png)](<계층적 PIC.png>)

### 1-4) DMA 입출력
- 기존 방식은 입출력장치와 메모리가 CPU를 거쳐야만 상호작용할 수 있었지만 DMA는 CPU를 거치지 않고도 상호작용 가능
- DMA(Direct Memory Access)는 직접 메모리에 접근할 수 있는 입출력 기능
  - DMA 입출력을 위해서는 시스템 버스에 연결된 DMA 컨트롤러가 필요

<br>

- DMA 입출력 과정
  1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기, 쓰기), 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령
  2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행, DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽고 씀
  3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트 작업이 끝났음을 알림

- 메모리 내의 정보를 하드 디스크에 백업하는 작업 과정
  1. CPU는 DMA 컨트롤러에 하드 디스크 주소, 수행할 연산(쓰기), 백업할 내용이 저장된 메모리의 주소 등의 정보와 함께 입출력 작업을 명령
   ![!\[alt text\](image.png)](<DMA-입출력작업명령.png>)
  2. DMA 컨트롤러는 CPU를 거치지 않고 메모리와 직접 상호작용하며 백업할 정보를 읽어오고 하드 디스크의 장치 컨트롤러에 보냄
  ![ !\[alt text\](image.png)](<DMA-백업 장치컨트롤러.png>)
  3. 백업이 끝나면 DMA 컨트롤러는 CPU에게 인터럽트를 걸어 작업이 끝났음을 알림
   ![!\[alt text\](image.png)](DMA-인터럽트종료.png)

<br>

- 입출력 장치와 메모리 사이에 주고 받을 데이터는 CPU를 거치지 않음
- CPU는 DMA 컨트롤러에게 입출력 작업 명령을 내리고 인터럽트만 받으면 되기 때문에 작업 부담이 줄어듦
- 하지만 DMA 컨트롤러는 시스템 버스로 메모리에 직접 접근이 가능하지만 공용 자원이기 때문에 동시 사용 불가능
  - CPU가 시스템 버스를 사용할 때 DMA 컨트롤러는 시스템 버스 사용 불가능
  - DMA 컨트롤러가 시스템 버스를 사용할 때 CPU가 시스템 버스를 사용할 수 없음  
  => DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이용하거나 일시적으로 CPU가 시스템 버스를 이용하지 않도록 허락을 구하고 집중적으로 사용함
  ![!\[alt text\](image.png)]
  (<사이클 스틸링.png>)

### 2) 입출력 버스
- CPU, 메모리, DMA 컨트롤러, 장치 컨트롤러가 모두 같은 버스를 공유하는 구성에서는 DMA를 위해 한번 메모리에 접근할 때마다 시스템 버스를 두번 사용하는 부작용이 있음  
![!\[alt text\](image.png)
](<시스템 버스 중복사용 부작용.png>)

  => DMA를 위해 시스템 버스를 자주 사용하면 CPU가 시스템 버스를 이용하지 못함, 입출력 버스라는 별도의 버스에 DMA 컨트롤러와 장치 컨트롤러들을 연결하여 해결

  ![!\[alt text\](image.png)](<입출력 버스.png>)
- PCI 버스, PCI Express(PCle) 버스 등

---
[맨 위로](#)

## Q&A
### Q1. 장치 컨트롤러와 장치 드라이버에 대해 설명하시오.
A1. 장치 컨트롤러란 CPU와 입출력장치 간의 통신을 중개하고 오류를 검출합니다. 데이터 레지스터에 CPU와 입출력장치 사이에 주고 받을 데이터가 담기며 상태 레지스터에서 작업할 준비가 되었다고 판단하면 제어 레지스터를 통해 제어 정보와 명령을 저장됩니다.

장치 드라이버는 장치 컨트롤러의 동작을 감지하고 제어하면서 장치 컨트롤러가 컴퓨터 내부와 정보를 주고 받을 수 있게 하는 프로그램입니다.

### Q2. 메모리 맵 입출력의 특징과 고립형 입출력 특징에 대해 설명하시오.
A2. 프로그램 입출력을 제어하는 방법으로 메모리 맵 입출력은 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하여 진행합니다.

이에 반해 고립형 입출력 방식은 메모리를 위한 주소 공간과 입출력 장치를 위한 주소 공간을 분리하여 사용합니다.

### Q3. 인터럽트 기반 입출력과 DMA 입출력의 특징에 대해 설명하시오.
A3. 인터럽트 기반 입출력은 입출력 장치가 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 멈추고 해당 인터럽트를 처리하기 위해 인터럽트 서비스 루틴을 실행한 후 다시 하던 일로 돌아오는 방식을 말합니다. PIC를 통해 우선순위를 판단하고 그 순서대로 진행합니다.

DMA 입출력은 메모리에 직접 접근하여 입출력 장치와 메모리 사이에 주고 받을 데이터는 CPU를 거치지 않습니다. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산, 메모리 주소 정보로 입출력 작업을 명령하고 끝나면 DMA 컨트롤러가 CPU에게 인터럽트 작업이 끝났음을 알립니다.
